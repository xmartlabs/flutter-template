opt_out_usage

def compilation_envs
  if File.file?('../.env')
    Dotenv.parse('../.env')
      .map { |key, value| "--dart-define=#{key}=#{value}" }
      .join(' ')
  else
    ''
  end
end

def root_path
  Dir.pwd.sub(/.*\Kfastlane/, '').sub(/.*\Kandroid/, '').sub(/.*\Kios/, '').sub(/.*\K\/\//, '')
end

private_lane :sh_on_root do |options|
  command = options[:command]
  sh("cd #{root_path} && #{command}")
end

private_lane :flutter_command do |options|
  command = options[:command]
  sh_on_root(command: "fvm flutter #{command}")
end

desc "Clean project"
private_lane :clean do
  flutter_command(command: "clean")
end

desc "Fetch flutter dependencies"
lane :fetch_dependencies do
  flutter_command(command: "pub get --suppress-analytics")
end

desc "Generate flutter generated code"
lane :build_autogenerated_code do
  flutter_command(command: "pub run build_runner build --delete-conflicting-outputs")
end

desc "Lint: Check code format"
lane :lint_format do
  flutter_command(command: "format --set-exit-if-changed .")
end

desc "Lint: Analyze code"
lane :lint_analyze do
  flutter_command(command: "analyze .")
end

desc "Run linters"
lane :lints do
  lint_format
  lint_analyze
end

desc "Run tests"
lane :tests do |options|
  flutter_command(command: "test --no-pub --coverage --suppress-analytics")
end

desc "Clean up project"
lane :clean_up do
  clean
  fetch_dependencies
  build_autogenerated_code
end

private_lane :generate_snapshot_changelog do
  changelog_from_git_commits(
     between: ["HEAD^", "HEAD"],
     pretty: "%s%n%nAuthor: %an <%ae>",
     date_format: "short",
  )
  header = Actions.lane_context[SharedValues::FL_CHANGELOG]
  changelog_from_git_commits(
    between: ["HEAD~10", "HEAD^"],
    pretty: "â€¢ %s",
    date_format: "short",
  )
  body = Actions.lane_context[SharedValues::FL_CHANGELOG]
    .split("\n")[0..10]
    .join("\n")
  ENV["CHANGELOG"] = "#{header}\n\nLast changes:\n#{body}"
  ENV["CHANGELOG"]
end
